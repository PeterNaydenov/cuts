"use strict";var e=require("@peter.naydenov/shortcuts"),n=require("ask-for-promise"),t=require("@peter.naydenov/log");function*r(e,n,t,r){let s=null;if(null===e)return yield*r.map((e=>[e,"show"])),void(yield[t,"show"]);if(!r||0===r.length)return n?(yield[e,"hide"],n.reverse(),yield*n.map((e=>[e,"hide"])),void(yield[t,"show"])):(yield[e,"hide"],void(yield[t,"show"]));if(r.includes(e)){for(let n=r.indexOf(e)+1;n<r.length;n++)yield[r[n],"show"];yield[t,"show"]}else{if(!n)return yield[e,"hide"],void(yield*r.map((e=>[e,"show"])));if(r.every(((e,t)=>n[t]===r[t]&&(s=t,!0))),null==s)return yield[e,"hide"],n.reverse(),yield*n.map((e=>[e,"hide"])),yield*r.map((e=>[e,"show"])),void(yield[t,"show"]);yield[e,"hide"];for(let e=n.length;e>s+1;e--)yield[n[e-1],"hide"];for(let e=s+1;e<r.length;e++)yield[r[e],"show"];yield[t,"show"]}}function s(e){return function(n,...t){const{askForPromise:r,deps:s}=e;return function(){const e=r();return n({task:e,dependencies:s()},...t),e.promise}}}module.exports=function(o={logLevel:0}){const c=e.shortcuts(),i=o.logLevel||0,u=t({level:i}),l={currentScene:null,currentParents:null,sceneNames:new Set,scenes:{},opened:!1,jumpStack:[]},d={},a={shortcutMngr:c,findInstructions:r,askForPromise:n,setInstruction:s({askForPromise:n,deps:c.getDependencies}),log:u};return d.hide=function(e,n){return function(t=1){const{askForPromise:r,shortcutMngr:s,setInstruction:o}=e,{currentScene:c,currentParents:i,scenes:u}=n,l=r(),d=[],a=i.length>0;let p;return s.pause(),d.push(o(u[c].hide)),a||(n.currentScene=null),a&&"*"===t&&[...i].reverse().forEach((e=>{p=n.currentParents.pop(),n.currentScene=p,d.push(o(u[e].hide))})),a&&!["*",1].includes(t)&&i.slice("-"+(t-1)).reverse().map((e=>{p=n.currentParents.pop(),n.currentScene=p,d.push(o(u[e].hide))})),(t=r.sequence(d)).onComplete((()=>{s.changeContext(n.currentScene),l.done()})),l.promise}}(a,l),d.listShortcuts=function(e,n){return function(e){const{scenes:t,sceneNames:r}=n;if(!r.has(e))return null;const{show:s,hide:o,parents:c,beforeUnload:i,afterLoad:u,...l}=t[e];return Object.keys(l)}}(0,l),d.setScenes=function(e,n){return function(t){const{shortcutMngr:r}=e;t.forEach((e=>{if(null==e)return;const{name:t,scene:s}=e;if(null==s)return void console.warn(`Scene ${t} is not defined`);s.parents||(s.parents=[]),n.scenes[t]=s,n.sceneNames.add(t);const{show:o,hide:c,parents:i,...u}=s,l={};l[t]=u,r.load(l)}))}}(a,l),d.show=function(e,n){return function({scene:t,options:r={ssr:!1}},...s){const{shortcutMngr:o,askForPromise:c,log:i,findInstructions:u,setInstruction:l}=e,d=c(),a=c(),{opened:p,scenes:h,sceneNames:f,currentPage:m}=n;if(m){const e=h[m].beforeHide;"function"==typeof e&&e({done:a.done,dependencies:o.getDependencies()})}else a.done(!0);return a.onComplete((e=>{if(!e)return d.done(),d.promise;if(!f.has(t)&&i)return i({message:`Scene ${t} is not available.`,level:1,type:"error"}),d.done(),d.promise;if(!p&&r.ssr)return n.opened=!0,n.currentPage=t,o.changeContext(t),d.done(),d.promise;const{show:a,parents:m=[]}=h[t];if("*"===m[0])return a().then((()=>d.done())),n.currentParents.push(n.currentPage),n.currentPage=t,d.promise;function g([e,t]){if("show"===t)n.currentScene&&n.currentParents.push(n.currentScene),n.currentScene=e;else{let e=n.currentParents.pop();n.currentScene=e}return h[e][t]}m.forEach((e=>f.has(e))),n.currentParents||(n.currentParents=[]);const y=u(n.currentScene,n.currentParents,t,m),S=[];for(let e of y)[e].map(g).map((e=>S.push(l(e),...s)));c.sequence(S).onComplete((()=>{n.opened=!0,o.changeContext(t),"function"==typeof h[t].afterShow&&h[t].afterShow({dependencies:o.getDependencies(),done:()=>{}}),d.done()}))})),d.promise}}(a,l),d.jump=function(e,n){return function({scene:t},...r){return e.jumpStack.push(e.currentScene),n({scene:t},...r)}}(l,d.show),d.jumpBack=function(e,n){return function({hops:t}={hops:1},...r){for(let n=0;n<t-1;n++)e.jumpStack.pop();if(0===e.jumpStack.length)return;const s=e.jumpStack.pop();return n({scene:s},...r)}}(l,d.show),d.jumpsReset=function(e){return function(){e.jumpStack=[]}}(l),d.loadPlugins=async function(e){const n=e.map((e=>`plugin${e}`)),t=await import("@peter.naydenov/shortcuts");return n.map((e=>t[e]))},d.setDependencies=e=>c.setDependencies(e),d.getDependencies=()=>c.getDependencies(),d.setNote=n=>e.shortcuts.setNote(n),d.listScenes=()=>[...l.sceneNames],d.enablePlugin=(e,n)=>c.enablePlugin(e,n),d.disablePlugin=e=>c.disablePlugin(e),d.emit=(e,...n)=>c.emit(e,...n),d};
