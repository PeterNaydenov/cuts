"use strict";var e=require("@peter.naydenov/shortcuts"),n=require("ask-for-promise"),r=require("@peter.naydenov/log");function*t(e,n,r,t){let s=null;if(null===e)return yield*t.map((e=>[e,"show"])),void(yield[r,"show"]);if(!t||0===t.length)return n?(yield[e,"hide"],n.reverse(),yield*n.map((e=>[e,"hide"])),void(yield[r,"show"])):(yield[e,"hide"],void(yield[r,"show"]));if(t.includes(e)){for(let n=t.indexOf(e)+1;n<t.length;n++)yield[t[n],"show"];yield[r,"show"]}else{if(!n)return yield[e,"hide"],void(yield*t.map((e=>[e,"show"])));if(t.every(((e,r)=>n[r]===t[r]&&(s=r,!0))),null==s)return yield[e,"hide"],n.reverse(),yield*n.map((e=>[e,"hide"])),yield*t.map((e=>[e,"show"])),void(yield[r,"show"]);yield[e,"hide"];for(let e=n.length;e>s+1;e--)yield[n[e-1],"hide"];for(let e=s+1;e<t.length;e++)yield[t[e],"show"];yield[r,"show"]}}function s(e){return function(n,...r){const{askForPromise:t,deps:s}=e;return function(){const e=t();return n({task:e,dependencies:s()},...r),e.promise}}}var o={close:function(e,n){return function(r=1){const{askForPromise:t,pgMngr:s,setInstruction:o}=e,{currentPage:i,currentParents:u,pages:a}=n,c=t(),l=[],p=u.length>0;let d;return s.pause(),l.push(o(a[i].hide)),p||(n.currentPage=null),p&&"*"===r&&[...u].reverse().forEach((e=>{d=n.currentParents.pop(),n.currentPage=d,l.push(o(a[e].hide))})),p&&!["*",1].includes(r)&&u.slice("-"+(r-1)).reverse().map((e=>{d=n.currentParents.pop(),n.currentPage=d,l.push(o(a[e].hide))})),(r=t.sequence(l)).onComplete((()=>{s.changeContext(n.currentPage),c.done()})),c.promise}},listShortcuts:function(e,n){return function(e){const{pages:r,pageNames:t}=n;if(!t.has(e))return null;const{show:s,hide:o,parents:i,...u}=r[e];return Object.keys(u)}},setPages:function(e,n){return function(r){const{pgMngr:t}=e;r.forEach((({name:e,page:r})=>{n.pages[e]=r,n.pageNames.add(e),r.parents||(r.parents=[]);const{show:s,hide:o,...i}=r,u={};u[e]=i,t.load(u)}))}},turnTo:function(e,n){return function({page:r,options:t={ssr:!1}},...s){const{pgMngr:o,askForPromise:i,log:u,findInstructions:a,setInstruction:c}=e,l=i(),{opened:p,pages:d,pageNames:g}=n;if(!g.has(r)&&u)return u({message:`Page ${r} is not available.`,level:1,type:"error"}),l.done(),l.promise;if(!p&&t.ssr)return n.opened=!0,n.currentPage=r,o.changeContext(r),l.done(),l.promise;const{show:h,parents:f}=d[r];if("*"===f[0])return h().then((()=>l.done())),n.currentParents.push(n.currentPage),n.currentPage=r,l.promise;if(!(f.forEach((e=>g.has(e)))||!0))return u&&u({message:`Some of '${r}' parent pages are not set.`,level:1,type:"error"}),l.done(),l.promise;function P([e,r]){if("show"===r)n.currentPage&&n.currentParents.push(n.currentPage),n.currentPage=e;else{let e=n.currentParents.pop();n.currentPage=e}return d[e][r]}n.currentParents||(n.currentParents=[]);const m=a(n.currentPage,n.currentParents,r,f),y=[];for(let e of m)[e].map(P).map((e=>y.push(c(e),...s)));return i.sequence(y).onComplete((()=>{n.opened=!0,o.changeContext(r),l.done()})),l.promise}}};module.exports=function(i={logLevel:0}){const u=e.shortcuts(),a=i.logLevel||0,c=r({level:a}),l={currentPage:null,currentParents:null,pageNames:new Set,pages:{},opened:!1},p={},d={},g={pgMngr:u,API:p,inAPI:d,findInstructions:t,askForPromise:n,setInstruction:s({askForPromise:n,deps:u.getDependencies}),log:c};return Object.entries(o).forEach((([e,n])=>{e.startsWith("_")?d[e]=n(g,l):p[e]=n(g,l)})),p.setDependencies=e=>u.setDependencies(e),p.getDependencies=()=>u.getDependencies(),p.setNote=n=>e.shortcuts.setNote(n),p.listPages=()=>[...l.pageNames],p.enablePlugin=(e,n)=>u.enablePlugin(e,n),p.disablePlugin=e=>u.disablePlugin(e),p.emit=(e,...n)=>u.emit(e,...n),p};
